<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Rejestrator Czasu Pracy</title>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; position: relative; }
    h1 { font-size: 48px; margin-top: 40px; }
    .header-controls { display: flex; align-items: center; justify-content: center; margin-bottom: 40px; }
    .btn {
      font-size: 44px; padding: 60px 60px;
      margin: 0px; border-radius: 12px;
      color: white; border: none; cursor: pointer;
    }
    .btn-wejscie { background: #28a745; margin-right: 10px; }
    .btn-wyjscie { background: #dc3545; margin-left: 10px; }
    .btn-export, .btn-clear {
      font-size: 24px; padding: 20px 40px; position: fixed; bottom: 10px;
    }
    .btn-export { background: #007bff; right: 10px; }
    .btn-clear { background: #ffc107; left: 10px; }
    #central-clock {
      font-size: 48px; font-weight: bold; background: transparent;
      padding: 20px; border: none; margin: 0 20px;
    }
    table { margin: 2px auto; border-collapse: collapse; width: 100%; }
    th, td {
      border: 1px solid #ddd; padding: 12px;
      font-size: 19px; text-align: center;
    }
    .pending { background: rgba(255,255,0,0.2); }
    .complete { background: rgba(40,167,69,0.35); }
    #reader {
      width: 400px; margin: 20px auto; display: none;
    }
    #logo-background {
      position: fixed; top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      opacity: 0.2; z-index: -1; pointer-events: none;
    }
    #logo-background img { height: 500px; }
    .msg {
      display: none; position: fixed;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      color: white; padding: 20px 40px;
      font-size: 24px; border-radius: 10px;
      z-index: 1000; text-align: center;
      opacity: 0;
      transition: opacity 0.5s ease;
    }
    #error-message { background: #dc3545; }
    #success-message { background: #28a745; }
  </style>
</head>
<body>

<div id="error-message" class="msg"></div>
<div id="success-message" class="msg"></div>

<div id="logo-background">
  <img src="https://cdn.glitch.global/55b49e7a-74e7-4448-b7d3-6e743971d1c8/logo%20MS.png?v=1745502701400" alt="MSys Logo" />
</div>

<h1>Rejestrator Czasu Pracy</h1>

<div class="header-controls">
  <button class="btn btn-wejscie" onclick="startScanner('Wejście')">Wejście</button>
  <div id="central-clock">00:00:00</div>
  <button class="btn btn-wyjscie" onclick="startScanner('Wyjście')">Wyjście</button>
</div>

<div id="reader"></div>

<table>
  <thead>
    <tr>
      <th>ID Pracownika</th>
      <th>Wejście</th>
      <th>Wyjście</th>
      <th>Czas pracy</th>
      <th>Status</th>
    </tr>
  </thead>
  <tbody id="historia"></tbody>
</table>

<button class="btn-export" onclick="eksportujCSV()">Eksportuj CSV</button>
<button class="btn-clear" onclick="wyczyscHistorie()">Wyczyść historię</button>

<script>
const PIN = "1234";

// KONFIGURACJA FORMULARZA
const FORM_URL = "https://docs.google.com/forms/d/e/1FAIpQLSdx7kemy7oERaNMKPnX-pt6jNYbnxj6e0mXSTe0cW6RnD_pVQ/formResponse";
const ENTRY_ID = "entry.413172395";
const ENTRY_TYP = "entry.583083047";

function pokazBlad(t1, t2) {
  const d = document.getElementById('error-message');
  d.innerHTML = `<strong style="font-size:28px;">${t1}</strong><br>${t2}`;
  d.style.display = 'block';
  setTimeout(() => { d.style.opacity = 1; }, 10);
  setTimeout(() => { d.style.opacity = 0; setTimeout(() => { d.style.display = 'none'; }, 500); }, 3000);
}

function sprawdzNiepelneRekordy() {
  const tbody = document.getElementById("historia");
  const teraz = new Date();
  for (let row of tbody.rows) {
    const id = row.cells[0].innerText;
    const wejscie = row.cells[1].innerText;
    const wyjscie = row.cells[2].innerText;
    if (wejscie && !wyjscie) {
      const czasWejscia = new Date(wejscie.replace(" ", "T"));
      const roznicaMs = teraz - czasWejscia;
      const godziny = roznicaMs / (1000 * 60 * 60);
      if (godziny >= 14) {
        row.cells[2].innerText = "brak wyjścia";
        row.cells[3].innerText = "-";
        row.cells[4].innerText = "Niepełne";
        row.className = "pending";
      }
    }
  }
  zapiszHistorie(); // zapisz zmiany
}
  
  
function pokazSukces(t1, t2) {
  const d = document.getElementById('success-message');
  d.innerHTML = `<strong style="font-size:28px;">${t1}</strong><br>${t2}`;
  d.style.display = 'block';
  setTimeout(() => { d.style.opacity = 1; }, 10);
  setTimeout(() => { d.style.opacity = 0; setTimeout(() => { d.style.display = 'none'; }, 500); }, 3000);
}

function wyslijDoFormularza(id, typ) {
  const formData = new FormData();
  formData.append(ENTRY_ID, id);
  formData.append(ENTRY_TYP, typ);
  fetch(FORM_URL, {
    method: "POST",
    mode: "no-cors",
    body: formData
  }).then(() => {
    console.log("Dane wysłane do Google Form");
  }).catch(err => {
    console.error("Błąd wysyłki:", err);
  });
}

function startScanner(typ) {
  const html5QrCode = new Html5Qrcode("reader");
  document.getElementById('reader').style.display = 'block';
  html5QrCode.start({ facingMode: "user" }, { fps: 10, qrbox: 250 },
    qrCodeMessage => {
      html5QrCode.stop().then(() => {
        document.getElementById('reader').style.display = 'none';
        const d = new Date();
        const dt = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}:${String(d.getSeconds()).padStart(2,'0')}`;
        rejestruj(qrCodeMessage, typ, dt);
        wyslijDoFormularza(qrCodeMessage, typ); // WAŻNE!
      });
    });
}

function rejestruj(id, typ, data) {
  const tbody = document.getElementById("historia");

  if (typ === "Wejście") {
    for (let row of tbody.rows) {
      if (row.cells[0].innerText === id && row.cells[2].innerText === "") {
        pokazBlad("Masz już wejście!", "Najpierw musisz się wylogować.");
        return;
      }
    }
    const row = tbody.insertRow(0);
    row.className = "pending";
    row.innerHTML = `<td>${id}</td><td>${data}</td><td></td><td></td><td>Pending</td>`;
    pokazSukces("Zarejestrowano wejście!", id);
  }

  else if (typ === "Wyjście") {
    for (let row of tbody.rows) {
      if (row.cells[0].innerText === id && row.cells[2].innerText === "") {
        row.cells[2].innerText = data;
        const start = new Date(row.cells[1].innerText.replace(' ', 'T'));
        const end = new Date(data.replace(' ', 'T'));
        const diff = end - start;
        if (!isNaN(diff)) {
          const h = Math.floor(diff / (1000 * 60 * 60));
          const m = Math.floor((diff / (1000 * 60)) % 60);
          row.cells[3].innerText = `${h}h ${m}m`;
        } else row.cells[3].innerText = "-";
        row.cells[4].innerText = "Complete";
        row.className = "complete";
        pokazSukces("Zarejestrowano wyjście!", id);
        zapiszHistorie();
        return;
      }
    }
    pokazBlad("Brak wejścia!", "Nie możesz się wylogować.");
  }

  zapiszHistorie();
}

function zapiszHistorie() {
  localStorage.setItem("historia", document.getElementById('historia').innerHTML);
}

function wczytajHistorie() {
  const h = localStorage.getItem("historia");
  if (h) document.getElementById('historia').innerHTML = h;
}

function wyczyscHistorie() {
  const wpisany = prompt("Podaj PIN:");
  if (wpisany === PIN) {
    if (confirm("Czy na pewno usunąć historię?")) {
      document.getElementById('historia').innerHTML = "";
      localStorage.removeItem("historia");
    }
  } else {
    pokazBlad("Błędny PIN!", "Spróbuj ponownie.");
  }
}

function eksportujCSV() {
  const rows = document.querySelectorAll("#historia tr");
  if (!rows.length) return alert("Brak danych do eksportu.");
  const d = new Date();
  const nazwa = `historia-${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}_${String(d.getHours()).padStart(2,'0')}-${String(d.getMinutes()).padStart(2,'0')}-${String(d.getSeconds()).padStart(2,'0')}.csv`;
  let csv = "ID,Wejscie,Wyjscie,Czas pracy,Status\n";
  rows.forEach(row => {
    const cells = row.querySelectorAll("td");
    csv += [...cells].map(td => td.innerText.trim()).join(",") + "\n";
  });
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const link = document.createElement("a");
  link.href = url;
  link.download = nazwa;
  link.click();
  URL.revokeObjectURL(url);
}

function updateClock() {
  const d = new Date();
  document.getElementById('central-clock').innerText =
    d.getHours().toString().padStart(2,'0') + ":" +
    d.getMinutes().toString().padStart(2,'0') + ":" +
    d.getSeconds().toString().padStart(2,'0');
}

setInterval(updateClock, 1000);
window.onload = () => {
  wczytajHistorie();
  updateClock();
  setInterval(updateClock, 1000);
  setInterval(sprawdzNiepelneRekordy, 60 * 1000); // co minutę
};
</script>

</body>
</html>
